import{G as E,L as P,c as _,j as v,q as W,b as j,B,n as b,r as F,V as L,s as G}from"./LegacyTriangleSplitter-D3liNpRX.js";import{M as U,b as z}from"./Evaluator-BUo8MRyP.js";const w=new F,H=new v,f=new L;class C extends W{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...t){return j.prototype.getVertexPosition.call(this,...t)}constructor(t,e,s=10,i=0){super(),this.material=e,this.geometry=new B,this.name="BVHRootHelper",this.depth=s,this.displayParents=!1,this.bvh=t,this.displayEdges=!0,this._group=i}raycast(){}update(){const t=this.bvh;this.geometry.dispose(),this.visible=!1,t&&(this.geometry=this.getGeometry(t),this.visible=!0)}getGeometry(t){const e=this._group;let s=null;if(e!==-1)s=this.getBVHBoundPositions(t,e);else{const n=t._roots.map((r,a)=>this.getBVHBoundPositions(t,a)),l=n.reduce((r,a)=>r+a.length,0);s=new Float32Array(l);let h=0;n.forEach(r=>{s.set(r,h),h+=r.length})}const i=this.getBVHBoundIndices(s),o=new B;return o.setIndex(new b(i,1,!1)),o.setAttribute("position",new b(s,3,!1)),o}getBVHBoundIndices(t){const e=t.length/24;let s,i;this.displayEdges?i=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):i=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),t.length>65535?s=new Uint32Array(i.length*e):s=new Uint16Array(i.length*e);const o=i.length;for(let n=0;n<e;n++){const l=n*8,h=n*o;for(let r=0;r<o;r++)s[h+r]=l+i[r]}return s}getBVHBoundPositions(t,e=0,s=null){const i=this.depth-1,o=this.displayParents;let n=0;t.traverse((r,a)=>{if(r>=i||a)return n++,!0;o&&n++},e);let l=0;const h=new Float32Array(24*n);return t.traverse((r,a,d)=>{const c=r>=i||a;if(c||o){z(0,d,w);const{min:p,max:u}=w;for(let g=-1;g<=1;g+=2){const I=g<0?p.x:u.x;for(let y=-1;y<=1;y+=2){const V=y<0?p.y:u.y;for(let m=-1;m<=1;m+=2){const A=m<0?p.z:u.z;f.set(I,V,A),s&&f.applyMatrix4(s),f.toArray(h,l),l+=3}}}return c}},e),h}}class x extends E{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(t){this.edgeMaterial.opacity=t,this.meshMaterial.opacity=t}get objectIndex(){return console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId}set objectIndex(t){console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId=t}constructor(t=null,e=null,s=10){t instanceof U&&(s=e||10,e=t,t=null),typeof e=="number"&&(s=e,e=null),super(),this.name="BVHHelper",this.depth=s,this.mesh=t,this.bvh=e,this.displayParents=!1,this.displayEdges=!0,this.instanceId=0,this._roots=[];const i=new P({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),o=new _({color:65416,transparent:!0,opacity:.3,depthWrite:!1});o.color=i.color,this.edgeMaterial=i,this.meshMaterial=o,this.update()}update(){const t=this.mesh,e=this.instanceId;let s=this.bvh||t.geometry.boundsTree||null;if(t&&t.isBatchedMesh&&t.boundsTrees&&!s&&e>=0){const o=t._drawInfo[e];o&&(s=t.boundsTrees[o.geometryIndex]||s)}const i=s?s._roots.length:0;for(;this._roots.length>i;){const o=this._roots.pop();o.geometry.dispose(),this.remove(o)}for(let o=0;o<i;o++){const{depth:n,edgeMaterial:l,meshMaterial:h,displayParents:r,displayEdges:a}=this;if(o>=this._roots.length){const c=new C(s,l,n,o);this.add(c),this._roots.push(c)}const d=this._roots[o];d.bvh=s,d.depth=n,d.displayParents=r,d.displayEdges=a,d.material=a?l:h,d.update()}}updateMatrixWorld(...t){const e=this.mesh,s=this.parent,i=this.instanceId;e!==null&&(e.updateWorldMatrix(!0,!1),s?this.matrix.copy(s.matrixWorld).invert().multiply(e.matrixWorld):this.matrix.copy(e.matrixWorld),(e.isInstancedMesh||e.isBatchedMesh)&&i>=0&&(e.getMatrixAt(i,H),this.matrix.multiply(H)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...t)}copy(t){this.depth=t.depth,this.mesh=t.mesh,this.bvh=t.bvh,this.opacity=t.opacity,this.color.copy(t.color)}clone(){return new x().copy(this)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].geometry.dispose()}}class T extends x{constructor(...t){console.warn("MeshBVHHelper: Class has been deprecated. Use BVHHelper instead."),super(...t)}}class q extends G{get color(){return this.material.color}constructor(t=[]){super(),this.frustumCulled=!1,this.setEdges(t)}setEdges(t){const{geometry:e}=this,s=t.flatMap(i=>[i.start,i.end]);e.dispose(),e.deleteAttribute("position"),e.setFromPoints(s)}}export{q as E,T as M};
