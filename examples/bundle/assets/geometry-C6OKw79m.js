import{T as H,V as U,d as C,W as j,e as $,S as k,D as q,A as J,P as K,O as Q,M as T,f as Y,g as Z,b as G,h as tt,a as V,B as et,c as rt,i as it}from"./TriangleSplitter-ByAGyBL2.js";import{g as at}from"./lil-gui.module.min-BH_YJbPT.js";import{G as ot,M as st}from"./meshopt_decoder.module-DK5bP9_f.js";import{E as nt,B as I,S as L,H as ut,a as lt,D as dt,I as ct,R as ht,A as P}from"./Evaluator-Coej1Gnr.js";const a=new H,F=new U,R=new C,_=new C,D=new C;class ft{constructor(t){this.geometry=t.geometry,this.randomFunction=Math.random,this.indexAttribute=this.geometry.index,this.positionAttribute=this.geometry.getAttribute("position"),this.normalAttribute=this.geometry.getAttribute("normal"),this.colorAttribute=this.geometry.getAttribute("color"),this.uvAttribute=this.geometry.getAttribute("uv"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(t){return this.weightAttribute=t?this.geometry.getAttribute(t):null,this}build(){const t=this.indexAttribute,o=this.positionAttribute,u=this.weightAttribute,r=t?t.count/3:o.count/3,i=new Float32Array(r);for(let l=0;l<r;l++){let p=1,f=3*l,m=3*l+1,v=3*l+2;t&&(f=t.getX(f),m=t.getX(m),v=t.getX(v)),u&&(p=u.getX(f)+u.getX(m)+u.getX(v)),a.a.fromBufferAttribute(o,f),a.b.fromBufferAttribute(o,m),a.c.fromBufferAttribute(o,v),p*=a.getArea(),i[l]=p}const e=new Float32Array(r);let n=0;for(let l=0;l<r;l++)n+=i[l],e[l]=n;return this.distribution=e,this}setRandomGenerator(t){return this.randomFunction=t,this}sample(t,o,u,r){const i=this._sampleFaceIndex();return this._sampleFace(i,t,o,u,r)}_sampleFaceIndex(){const t=this.distribution[this.distribution.length-1];return this._binarySearch(this.randomFunction()*t)}_binarySearch(t){const o=this.distribution;let u=0,r=o.length-1,i=-1;for(;u<=r;){const e=Math.ceil((u+r)/2);if(e===0||o[e-1]<=t&&o[e]>t){i=e;break}else t<o[e]?r=e-1:u=e+1}return i}_sampleFace(t,o,u,r,i){let e=this.randomFunction(),n=this.randomFunction();e+n>1&&(e=1-e,n=1-n);const l=this.indexAttribute;let p=t*3,f=t*3+1,m=t*3+2;return l&&(p=l.getX(p),f=l.getX(f),m=l.getX(m)),a.a.fromBufferAttribute(this.positionAttribute,p),a.b.fromBufferAttribute(this.positionAttribute,f),a.c.fromBufferAttribute(this.positionAttribute,m),o.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)),u!==void 0&&(this.normalAttribute!==void 0?(a.a.fromBufferAttribute(this.normalAttribute,p),a.b.fromBufferAttribute(this.normalAttribute,f),a.c.fromBufferAttribute(this.normalAttribute,m),u.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)).normalize()):a.getNormal(u)),r!==void 0&&this.colorAttribute!==void 0&&(a.a.fromBufferAttribute(this.colorAttribute,p),a.b.fromBufferAttribute(this.colorAttribute,f),a.c.fromBufferAttribute(this.colorAttribute,m),F.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)),r.r=F.x,r.g=F.y,r.b=F.z),i!==void 0&&this.uvAttribute!==void 0&&(R.fromBufferAttribute(this.uvAttribute,p),_.fromBufferAttribute(this.uvAttribute,f),D.fromBufferAttribute(this.uvAttribute,m),i.set(0,0).addScaledVector(R,e).addScaledVector(_,n).addScaledVector(D,1-(e+n))),this}}const c={operation:L,wireframe:!1,displayBrushes:!1,shadows:!0,useGroups:!0,consolidateGroups:!0,randomize:()=>{N(),M()}};let b,y,S,A,z,s,B,d,W,h,O,g,x=new nt;x.attributes=["position","normal"];x.useGroups=!1;const E=new Map;mt();async function mt(){z=document.getElementById("output"),b=new j({antialias:!0}),b.setPixelRatio(window.devicePixelRatio),b.setSize(window.innerWidth,window.innerHeight),b.setClearColor(1118481,1),b.shadowMap.enabled=!0,b.shadowMap.type=$,document.body.appendChild(b.domElement),S=new k,g=new q(16777215,3.5),g.position.set(1,2,1),S.add(g,new J(11583173,.35));const t=g.shadow.camera;g.castShadow=!0,g.shadow.mapSize.setScalar(4096),g.shadow.bias=1e-5,g.shadow.normalBias=.01,t.left=t.bottom=-2.5,t.right=t.top=2.5,t.updateProjectionMatrix(),y=new K(75,window.innerWidth/window.innerHeight,.1,50),y.position.set(0,.65,2.5),y.far=100,y.updateProjectionMatrix(),new Q(y,b.domElement);const o=new T(new Y,new Z({opacity:.05}));o.material.color.set(14743546),o.rotation.x=-Math.PI/2,o.scale.setScalar(10),o.position.y=-.5,o.receiveShadow=!0,S.add(o);const r=(await new ot().setMeshoptDecoder(st).loadAsync("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/stanford-bunny/bunny.glb")).scene.children[0].geometry;r.computeVertexNormals(),s=new I(r,new G),s.position.y=-.5,s.updateMatrixWorld(),s.receiveShadow=!0,S.add(s),d=new G,B=[],W=new ft(s),W.build();for(let e=0;e<50;e++){const n=new I(new tt(1,15,15),d);n.receiveShadow=!0,S.add(n),B.push(n)}s.material.opacity=.15,s.material.transparent=!0,s.material.depthWrite=!1,s.material.polygonOffset=!0,s.material.polygonOffsetFactor=.1,s.material.polygonOffsetUnits=.1,s.material.side=V,s.material.premultipliedAlpha=!0,s.material.color.set(14743546),d.opacity=.15,d.transparent=!0,d.depthWrite=!1,d.polygonOffset=!0,d.polygonOffsetFactor=.1,d.polygonOffsetUnits=.1,d.side=V,d.premultipliedAlpha=!0,d.roughness=.25,d.color.set(5099745);let i;i=s.material.clone(),i.opacity=1,i.transparent=!1,i.depthWrite=!0,E.set(s.material,i),i=d.clone(),i.opacity=1,i.transparent=!1,i.depthWrite=!0,E.set(d,i),h=new T(new et,new G({roughness:.1,flatShading:!1,polygonOffset:!0,polygonOffsetUnits:1,polygonOffsetFactor:1})),h.castShadow=!0,h.receiveShadow=!0,S.add(h),O=new T(h.geometry,new rt({wireframe:!0,color:0,opacity:.15,transparent:!0})),O.material.color.set(5398),S.add(O),A=new at,A.add(c,"operation",{ADDITION:P,SUBTRACTION:L,REVERSE_SUBTRACTION:ht,INTERSECTION:ct,DIFFERENCE:dt,HOLLOW_SUBTRACTION:lt,HOLLOW_INTERSECTION:ut}).onChange(()=>{M()}),A.add(c,"displayBrushes"),A.add(c,"shadows"),A.add(c,"wireframe"),A.add(c,"useGroups").onChange(M),A.add(c,"consolidateGroups").onChange(M),A.add(c,"randomize"),window.addEventListener("resize",function(){y.aspect=window.innerWidth/window.innerHeight,y.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight)},!1),N(),M(),X()}function M(){const w=window.performance.now();let t=B[0];x.useGroups=c.useGroups,x.consolidateGroups=c.consolidateGroups;for(let r=1,i=B.length;r<i;r++){const e=B[r];t=x.evaluate(t,e,P),t.material=d}x.evaluate(s,t,c.operation,h),c.useGroups?h.material=h.material.map(r=>E.get(r)):h.material=E.get(s.material);const o=window.performance.now()-w,u=h.geometry;z.innerText=`${o.toFixed(3)}ms
${u.groups.length} groups
${Array.isArray(h.material)?h.material.length:1} materials`}function N(){for(let w=0;w<B.length;w++){const t=B[w];W.sample(t.position),t.position.applyMatrix4(s.matrixWorld),t.scale.setScalar(it.lerp(.05,.15,Math.random())),t.updateMatrixWorld()}}function X(){requestAnimationFrame(X),O.visible=c.wireframe,s.visible=c.displayBrushes,B.forEach(w=>w.visible=c.displayBrushes),g.castShadow=c.shadows,b.render(S,y)}
