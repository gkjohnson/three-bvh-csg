import{T as H,V as U,d as C,W as j,e as $,S as k,D as q,A as J,P as K,O as Q,b as T,f as Y,g as Z,M as G,h as tt,a as V,B as et,c as it,i as rt}from"./LegacyTriangleSplitter-D3liNpRX.js";import{g as at}from"./lil-gui.module.min-BH_YJbPT.js";import{G as ot,M as st}from"./meshopt_decoder.module-D5sC7iW3.js";import{E as nt,B as I,S as L,a as ut,H as lt,D as dt,I as ct,R as ht,A as P}from"./Evaluator-BUo8MRyP.js";const a=new H,O=new U,R=new C,_=new C,D=new C;class ft{constructor(t){this.geometry=t.geometry,this.randomFunction=Math.random,this.indexAttribute=this.geometry.index,this.positionAttribute=this.geometry.getAttribute("position"),this.normalAttribute=this.geometry.getAttribute("normal"),this.colorAttribute=this.geometry.getAttribute("color"),this.uvAttribute=this.geometry.getAttribute("uv"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(t){return this.weightAttribute=t?this.geometry.getAttribute(t):null,this}build(){const t=this.indexAttribute,o=this.positionAttribute,u=this.weightAttribute,i=t?t.count/3:o.count/3,r=new Float32Array(i);for(let l=0;l<i;l++){let p=1,f=3*l,m=3*l+1,F=3*l+2;t&&(f=t.getX(f),m=t.getX(m),F=t.getX(F)),u&&(p=u.getX(f)+u.getX(m)+u.getX(F)),a.a.fromBufferAttribute(o,f),a.b.fromBufferAttribute(o,m),a.c.fromBufferAttribute(o,F),p*=a.getArea(),r[l]=p}const e=new Float32Array(i);let n=0;for(let l=0;l<i;l++)n+=r[l],e[l]=n;return this.distribution=e,this}setRandomGenerator(t){return this.randomFunction=t,this}sample(t,o,u,i){const r=this._sampleFaceIndex();return this._sampleFace(r,t,o,u,i)}_sampleFaceIndex(){const t=this.distribution[this.distribution.length-1];return this._binarySearch(this.randomFunction()*t)}_binarySearch(t){const o=this.distribution;let u=0,i=o.length-1,r=-1;for(;u<=i;){const e=Math.ceil((u+i)/2);if(e===0||o[e-1]<=t&&o[e]>t){r=e;break}else t<o[e]?i=e-1:u=e+1}return r}_sampleFace(t,o,u,i,r){let e=this.randomFunction(),n=this.randomFunction();e+n>1&&(e=1-e,n=1-n);const l=this.indexAttribute;let p=t*3,f=t*3+1,m=t*3+2;return l&&(p=l.getX(p),f=l.getX(f),m=l.getX(m)),a.a.fromBufferAttribute(this.positionAttribute,p),a.b.fromBufferAttribute(this.positionAttribute,f),a.c.fromBufferAttribute(this.positionAttribute,m),o.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)),u!==void 0&&(this.normalAttribute!==void 0?(a.a.fromBufferAttribute(this.normalAttribute,p),a.b.fromBufferAttribute(this.normalAttribute,f),a.c.fromBufferAttribute(this.normalAttribute,m),u.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)).normalize()):a.getNormal(u)),i!==void 0&&this.colorAttribute!==void 0&&(a.a.fromBufferAttribute(this.colorAttribute,p),a.b.fromBufferAttribute(this.colorAttribute,f),a.c.fromBufferAttribute(this.colorAttribute,m),O.set(0,0,0).addScaledVector(a.a,e).addScaledVector(a.b,n).addScaledVector(a.c,1-(e+n)),i.r=O.x,i.g=O.y,i.b=O.z),r!==void 0&&this.uvAttribute!==void 0&&(R.fromBufferAttribute(this.uvAttribute,p),_.fromBufferAttribute(this.uvAttribute,f),D.fromBufferAttribute(this.uvAttribute,m),r.set(0,0).addScaledVector(R,e).addScaledVector(_,n).addScaledVector(D,1-(e+n))),this}}const d={operation:L,wireframe:!1,displayBrushes:!1,shadows:!0,useGroups:!0,consolidateGroups:!0,randomize:()=>{N(),M()}};let b,y,S,A,z,s,B,c,W,h,v,g,x=new nt;x.attributes=["position","normal"];x.useGroups=!1;const E=new Map;mt();async function mt(){z=document.getElementById("output"),b=new j({antialias:!0}),b.setPixelRatio(window.devicePixelRatio),b.setSize(window.innerWidth,window.innerHeight),b.setClearColor(1118481,1),b.shadowMap.enabled=!0,b.shadowMap.type=$,document.body.appendChild(b.domElement),S=new k,g=new q(16777215,3.5),g.position.set(1,2,1),S.add(g,new J(11583173,.35));const t=g.shadow.camera;g.castShadow=!0,g.shadow.mapSize.setScalar(4096),g.shadow.bias=1e-5,g.shadow.normalBias=.01,t.left=t.bottom=-2.5,t.right=t.top=2.5,t.updateProjectionMatrix(),y=new K(75,window.innerWidth/window.innerHeight,.1,50),y.position.set(0,.65,2.5),y.far=100,y.updateProjectionMatrix(),new Q(y,b.domElement);const o=new T(new Y,new Z({opacity:.05}));o.material.color.set(14743546),o.rotation.x=-Math.PI/2,o.scale.setScalar(10),o.position.y=-.5,o.receiveShadow=!0,S.add(o);const i=(await new ot().setMeshoptDecoder(st).loadAsync("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/stanford-bunny/bunny.glb")).scene.children[0].geometry;i.computeVertexNormals(),s=new I(i,new G),s.position.y=-.5,s.updateMatrixWorld(),s.receiveShadow=!0,S.add(s),c=new G,B=[],W=new ft(s),W.build();for(let e=0;e<50;e++){const n=new I(new tt(1,15,15),c);n.receiveShadow=!0,S.add(n),B.push(n)}s.material.opacity=.15,s.material.transparent=!0,s.material.depthWrite=!1,s.material.polygonOffset=!0,s.material.polygonOffsetFactor=.1,s.material.polygonOffsetUnits=.1,s.material.side=V,s.material.premultipliedAlpha=!0,s.material.color.set(14743546),c.opacity=.15,c.transparent=!0,c.depthWrite=!1,c.polygonOffset=!0,c.polygonOffsetFactor=.1,c.polygonOffsetUnits=.1,c.side=V,c.premultipliedAlpha=!0,c.roughness=.25,c.color.set(5099745);let r;r=s.material.clone(),r.opacity=1,r.transparent=!1,r.depthWrite=!0,E.set(s.material,r),r=c.clone(),r.opacity=1,r.transparent=!1,r.depthWrite=!0,E.set(c,r),h=new T(new et,new G({roughness:.1,flatShading:!1,polygonOffset:!0,polygonOffsetUnits:1,polygonOffsetFactor:1})),h.castShadow=!0,h.receiveShadow=!0,S.add(h),v=new T(h.geometry,new it({wireframe:!0,color:0,opacity:.15,transparent:!0})),v.material.color.set(5398),S.add(v),A=new at,A.add(d,"operation",{ADDITION:P,SUBTRACTION:L,REVERSE_SUBTRACTION:ht,INTERSECTION:ct,DIFFERENCE:dt,HOLLOW_SUBTRACTION:lt,HOLLOW_INTERSECTION:ut}).onChange(()=>{M()}),A.add(d,"displayBrushes"),A.add(d,"shadows"),A.add(d,"wireframe"),A.add(d,"useGroups").onChange(M),A.add(d,"consolidateGroups").onChange(M),A.add(d,"randomize"),window.addEventListener("resize",function(){y.aspect=window.innerWidth/window.innerHeight,y.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight)},!1),N(),M(),X()}function M(){const w=window.performance.now();let t=B[0];x.useGroups=d.useGroups,x.consolidateGroups=d.consolidateGroups;for(let i=1,r=B.length;i<r;i++){const e=B[i];t=x.evaluate(t,e,P)}x.evaluate(s,t,d.operation,h),v.position.copy(h.position),d.useGroups?h.material=h.material.map(i=>E.get(i)):h.material=E.get(s.material);const o=window.performance.now()-w,u=h.geometry;z.innerText=`${o.toFixed(3)}ms
${u.groups.length} groups
${Array.isArray(h.material)?h.material.length:1} materials`}function N(){for(let w=0;w<B.length;w++){const t=B[w];W.sample(t.position),t.position.applyMatrix4(s.matrixWorld),t.scale.setScalar(rt.lerp(.05,.15,Math.random())),t.updateMatrixWorld()}}function X(){requestAnimationFrame(X),v.visible=d.wireframe,s.visible=d.displayBrushes,B.forEach(w=>w.visible=d.displayBrushes),g.castShadow=d.shadows,b.render(S,y)}
